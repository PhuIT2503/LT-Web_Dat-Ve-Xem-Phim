<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Khách Hàng - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- DARK THEME CSS --- */
        :root { 
            --primary: #e50914; 
            --dark: #141414;        /* Nền chính */
            --light-dark: #181818;  /* Nền phụ (Card, Table) */
            --text-white: #ffffff;
            --text-grey: #b3b3b3;
            --border-color: #333;
        }

        body { margin: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; display: flex; background: var(--dark); color: var(--text-white); }
        
        /* Sidebar */
        .sidebar { width: 250px; background: #000; color: #fff; height: 100vh; position: fixed; border-right: 1px solid var(--border-color); }
        .sidebar .logo { padding: 20px; font-size: 1.8rem; font-weight: bold; color: var(--primary); text-align: center; border-bottom: 1px solid var(--border-color); letter-spacing: 1px; }
        .sidebar ul { list-style: none; padding: 0; margin-top: 20px; }
        .sidebar li a { display: block; padding: 15px 20px; color: var(--text-grey); text-decoration: none; transition: 0.3s; border-left: 3px solid transparent; font-size: 1rem; }
        .sidebar li a:hover, .sidebar li a.active { background: var(--light-dark); color: #fff; border-left-color: var(--primary); }
        .sidebar li a i { margin-right: 15px; width: 20px; text-align: center; }
        
        /* Main Content */
        .main-content { margin-left: 250px; flex: 1; padding: 30px; }
        
        /* Header */
        .header { background: var(--light-dark); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; margin-bottom: 30px; border: 1px solid var(--border-color); }
        .header h2 { margin: 0; font-size: 1.5rem; }
        .admin-profile { color: var(--text-grey); }
        .admin-profile strong { color: var(--primary); margin-left: 5px; }
        
        /* Table Styles */
        .table-container { background: var(--light-dark); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .data-table { width: 100%; border-collapse: collapse; color: var(--text-grey); }
        .data-table th, .data-table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { background: #000; color: var(--text-white); font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        .data-table tbody tr:hover { background-color: rgba(255,255,255,0.05); }
        .data-table td { color: var(--text-white); }

        /* Badge Styles (Vàng/Bạc) */
        .badge-vip { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; color: #000; display: inline-block;}
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="logo">GemFlix ADMIN</div>
        <ul>
            <li><a href="index.html"><i class="fa-solid fa-chart-line"></i> Tổng Quan & Phim</a></li>
            <li><a href="showtimes.html"><i class="fa-solid fa-calendar-days"></i> Lịch Chiếu</a></li>
            <li><a href="customers.html" class="active"><i class="fa-solid fa-users"></i> Khách Hàng</a></li>
            <li><a href="#" id="admin-logout"><i class="fa-solid fa-right-from-bracket"></i> Đăng Xuất</a></li>
        </ul>
    </aside>

    <div class="main-content">
        <div class="header">
            <h2>Quản Lý Khách Hàng</h2>
            <div class="admin-profile">Xin chào, <strong id="admin-name">Admin</strong></div>
        </div>

        <div class="table-container">
            <h3 style="margin-bottom: 20px;">Danh Sách Thành Viên</h3>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tên Khách Hàng</th>
                        <th>Email</th>
                        <th>Số Vé Đã Mua</th>
                        <th>Tổng Chi Tiêu</th>
                        <th>Hạng</th>
                    </tr>
                </thead>
                <tbody id="customer-list">
                    <tr><td colspan="6" style="text-align:center; padding: 30px;">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE_URL = "http://localhost/LT-Web_Dat-Ve-Xem-Phim/backend/api";

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAdminAccess();
            loadCustomers();
            
            document.getElementById('admin-logout').addEventListener('click', async (e) => {
                e.preventDefault();
                await fetch(`${API_BASE_URL}/auth/logout.php`, {credentials: 'include'});
                window.location.href = '../index.html';
            });
        });

        async function checkAdminAccess() {
            try {
                const res = await fetch(`${API_BASE_URL}/auth/me.php`, {credentials: 'include'});
                const user = await res.json();
                if (!res.ok || user.role !== 'admin') { window.location.href = '../index.html'; } 
                else { document.getElementById('admin-name').textContent = user.username; }
            } catch (e) { window.location.href = '../login.html'; }
        }

        async function loadCustomers() {
            try {
                const res = await fetch(`${API_BASE_URL}/admin/customers.php`, {credentials: 'include'});
                const users = await res.json();
                
                const tbody = document.getElementById('customer-list');
                if(users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Chưa có khách hàng nào.</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(u => {
                    const totalSpent = parseInt(u.total_spent);
                    // Cập nhật màu sắc Badge cho nổi bật trên nền đen
                    let rank = `<span style="color: #aaa">Thành Viên</span>`;
                    if(totalSpent > 1000000) rank = `<span class="badge-vip" style="background:#f1c40f;">Vàng</span>`;
                    else if(totalSpent > 500000) rank = `<span class="badge-vip" style="background:#bdc3c7;">Bạc</span>`;

                    return `
                        <tr>
                            <td>#${u.id}</td>
                            <td style="font-weight:bold; color: var(--primary);">${u.username}</td>
                            <td>${u.email}</td>
                            <td>${u.total_bookings} vé</td>
                            <td style="color:#e50914; font-weight:bold">${totalSpent.toLocaleString('vi-VN')} đ</td>
                            <td>${rank}</td>
                        </tr>
                    `;
                }).join('');
            } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>